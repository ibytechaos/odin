# Odin Framework Docker Compose Configuration
#
# Usage:
#   docker-compose up -d              # Start all services
#   docker-compose up -d odin         # Start backend only
#   docker-compose up -d odin ui      # Start backend + UI
#
# Prerequisites:
#   - External 'services' network with Redis and PostgreSQL
#   - External 'proxy' network with Traefik (optional)

services:
  # Odin Backend - Unified server with all protocols
  odin:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: odin
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      # Override database URLs to use Docker internal service names
      DATABASE_URL: postgresql://odin:${POSTGRES_PASSWORD:-xietting}@postgres:5432/odin
      REDIS_URL: redis://:${REDIS_PASSWORD:-xietting}@redis:6379/2
      # OpenTelemetry (if using Jaeger in services network)
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    volumes:
      # Code hot-reload (development mode)
      - .:/app
      # Obsidian vault mount
      - ${HOME}/Documents/Obsidian/Odin:/obsidian
      # Downloads directory
      - ./downloads:/app/downloads
      # Custom plugins
      - ./plugins:/app/plugins:ro
    networks:
      - services
      - proxy
    labels:
      - "traefik.enable=true"
      # Backend API
      - "traefik.http.routers.odin.rule=Host(`odin.mcp.ibytechaos.com`)"
      - "traefik.http.routers.odin.entrypoints=websecure"
      - "traefik.http.routers.odin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.odin.middlewares=secure-headers@file"
      - "traefik.http.services.odin.loadbalancer.server.port=8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Odin UI - Next.js CopilotKit Frontend
  ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: odin-ui
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # Connect to backend via internal network
      - NEXT_PUBLIC_COPILOTKIT_URL=http://odin:8000/copilotkit
    depends_on:
      odin:
        condition: service_healthy
    networks:
      - services
      - proxy
    labels:
      - "traefik.enable=true"
      # UI Frontend
      - "traefik.http.routers.odin-ui.rule=Host(`chat.odin.mcp.ibytechaos.com`)"
      - "traefik.http.routers.odin-ui.entrypoints=websecure"
      - "traefik.http.routers.odin-ui.tls.certresolver=letsencrypt"
      - "traefik.http.routers.odin-ui.middlewares=secure-headers@file"
      - "traefik.http.services.odin-ui.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  services:
    external: true
  proxy:
    external: true
